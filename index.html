<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <!-- å®šç¾©æ–‡æª”å­—ç¬¦ç·¨ç¢¼ç‚ºUTF-8 -->
    <meta charset="UTF-8">
    <!-- è¨­ç½®è¦–å£ä»¥ç¢ºä¿åœ¨ç§»å‹•è¨­å‚™ä¸Šæ­£ç¢ºé¡¯ç¤º -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- è¨­ç½®é é¢æ¨™é¡Œ -->
    <title>æº«æ¿•åº¦ç›£æ§</title>
    <!-- å¼•å…¥MQTTå®¢æˆ¶ç«¯åº« -->
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <!-- å¼•å…¥Chart.jsåœ–è¡¨åº« -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- å¼•å…¥Chart.jsæ—¥æœŸé©é…å™¨ -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        /* å®šç¾©CSSè®Šé‡ï¼ˆè‡ªå®šç¾©å±¬æ€§ï¼‰ç”¨æ–¼é¡è‰²ä¸»é¡Œ */
        :root {
            --primary: #1c8c1c; /* ä¸»è¦é¡è‰² */
            --secondary: #1b7d49; /* æ¬¡è¦é¡è‰² */
            --success: #4CAF50; /* æˆåŠŸç‹€æ…‹é¡è‰² */
            --warning: #FF9800; /* è­¦å‘Šç‹€æ…‹é¡è‰² */
            --error: #f44336; /* éŒ¯èª¤ç‹€æ…‹é¡è‰² */
        }

        /* é‡ç½®æ‰€æœ‰å…ƒç´ çš„é»˜èªé‚Šè·å’Œå…§é‚Šè·ï¼Œä¸¦è¨­ç½®ç›’æ¨¡å‹ç‚ºborder-box */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* è¨­ç½®é é¢ä¸»é«”æ¨£å¼ */
        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif; /* è¨­ç½®å­—é«” */
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); /* è¨­ç½®æ¼¸è®ŠèƒŒæ™¯ */
            min-height: 100vh; /* æœ€å°é«˜åº¦ç‚ºè¦–å£é«˜åº¦ */
            padding: 20px; /* å…§é‚Šè· */
            color: white; /* æ–‡å­—é¡è‰² */
        }

        /* ä¸»å®¹å™¨æ¨£å¼ */
        .container {
            max-width: 1200px; /* æœ€å¤§å¯¬åº¦ */
            margin: 0 auto; /* æ°´å¹³å±…ä¸­ */
        }

        /* é é¢é ­éƒ¨æ¨£å¼ */
        .header {
            text-align: center; /* æ–‡å­—å±…ä¸­ */
            margin-bottom: 30px; /* åº•éƒ¨å¤–é‚Šè· */
            background: rgba(255,255,255,0.1); /* åŠé€æ˜èƒŒæ™¯ */
            padding: 20px; /* å…§é‚Šè· */
            border-radius: 20px; /* åœ“è§’ */
            backdrop-filter: blur(10px); /* èƒŒæ™¯æ¨¡ç³Šæ•ˆæœ */
        }

        /* ç‹€æ…‹æ¬„æ¨£å¼ */
        .status-bar {
            display: grid; /* ä½¿ç”¨ç¶²æ ¼ä½ˆå±€ */
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); /* éŸ¿æ‡‰å¼ç¶²æ ¼åˆ— */
            gap: 15px; /* ç¶²æ ¼é–“è· */
            margin-bottom: 25px; /* åº•éƒ¨å¤–é‚Šè· */
        }

        /* ç‹€æ…‹é …æ¨£å¼ */
        .status-item {
            background: rgba(255,255,255,0.1); /* åŠé€æ˜èƒŒæ™¯ */
            padding: 15px; /* å…§é‚Šè· */
            border-radius: 15px; /* åœ“è§’ */
            text-align: center; /* æ–‡å­—å±…ä¸­ */
            backdrop-filter: blur(10px); /* èƒŒæ™¯æ¨¡ç³Šæ•ˆæœ */
        }

        /* ç‹€æ…‹æŒ‡ç¤ºé»æ¨£å¼ */
        .status-dot {
            display: inline-block; /* è¡Œå…§å¡Šå…ƒç´  */
            width: 10px; /* å¯¬åº¦ */
            height: 10px; /* é«˜åº¦ */
            border-radius: 50%; /* åœ“å½¢ */
            margin-right: 8px; /* å³é‚Šè· */
        }

        /* é€£æ¥ç‹€æ…‹æ¨£å¼ */
        .connected {
            background: var(--success);
        }
        /* é€£æ¥æˆåŠŸæ™‚ç‚ºç¶ è‰² */
        .disconnected {
            background: var(--error);
        }
        /* æ–·é–‹é€£æ¥æ™‚ç‚ºç´…è‰² */
        .connecting {
            background: var(--warning);
        }
        /* é€£æ¥ä¸­æ™‚ç‚ºæ©™è‰² */

        /* å¯¦æ™‚æ•¸æ“šå¡ç‰‡å®¹å™¨æ¨£å¼ */
        .real-time-cards {
            display: grid; /* ä½¿ç”¨ç¶²æ ¼ä½ˆå±€ */
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); /* éŸ¿æ‡‰å¼ç¶²æ ¼åˆ— */
            gap: 20px; /* ç¶²æ ¼é–“è· */
            margin-bottom: 25px; /* åº•éƒ¨å¤–é‚Šè· */
        }

        /* å–®å€‹å¡ç‰‡æ¨£å¼ */
        .card {
            background: rgba(255,255,255,0.1); /* åŠé€æ˜èƒŒæ™¯ */
            border-radius: 20px; /* åœ“è§’ */
            padding: 25px; /* å…§é‚Šè· */
            text-align: center; /* æ–‡å­—å±…ä¸­ */
            backdrop-filter: blur(10px); /* èƒŒæ™¯æ¨¡ç³Šæ•ˆæœ */
            border: 1px solid rgba(255,255,255,0.2); /* åŠé€æ˜é‚Šæ¡† */
            transition: transform 0.3s ease; /* æ‡¸åœå‹•ç•«éæ¸¡ */
        }

            /* å¡ç‰‡æ‡¸åœæ•ˆæœ */
            .card:hover {
                transform: translateY(-5px); /* å‘ä¸Šç§»å‹•5åƒç´  */
            }

        /* å¡ç‰‡åœ–æ¨™æ¨£å¼ */
        .card-icon {
            font-size: 3em; /* åœ–æ¨™å¤§å° */
            margin-bottom: 15px; /* åº•éƒ¨å¤–é‚Šè· */
        }

        /* å¡ç‰‡æ•¸å€¼æ¨£å¼ */
        .card-value {
            font-size: 2.8em; /* å­—é«”å¤§å° */
            font-weight: bold; /* ç²—é«” */
            margin: 10px 0; /* ä¸Šä¸‹å¤–é‚Šè· */
        }

        /* å¡ç‰‡å–®ä½æ¨£å¼ */
        .card-unit {
            font-size: 0.5em; /* ç›¸å°å­—é«”å¤§å° */
            opacity: 0.8; /* é€æ˜åº¦ */
        }

        /* åœ–è¡¨å®¹å™¨æ¨£å¼ */
        .chart-container {
            background: rgba(255,255,255,0.1); /* åŠé€æ˜èƒŒæ™¯ */
            border-radius: 20px; /* åœ“è§’ */
            padding: 25px; /* å…§é‚Šè· */
            margin-bottom: 25px; /* åº•éƒ¨å¤–é‚Šè· */
            backdrop-filter: blur(10px); /* èƒŒæ™¯æ¨¡ç³Šæ•ˆæœ */
            position: relative; /* ç›¸å°å®šä½ */
            min-height: 400px; /* æœ€å°é«˜åº¦ */
        }

        /* åœ–è¡¨é ­éƒ¨æ¨£å¼ */
        .chart-header {
            display: flex; /* ä½¿ç”¨å½ˆæ€§ä½ˆå±€ */
            justify-content: space-between; /* å…©ç«¯å°é½Š */
            align-items: center; /* å‚ç›´å±…ä¸­ */
            margin-bottom: 20px; /* åº•éƒ¨å¤–é‚Šè· */
            flex-wrap: wrap; /* å…è¨±æ›è¡Œ */
            gap: 15px; /* å…ƒç´ é–“è· */
        }

        /* åœ–è¡¨æ§åˆ¶æŒ‰éˆ•å®¹å™¨æ¨£å¼ */
        .chart-controls {
            display: flex; /* ä½¿ç”¨å½ˆæ€§ä½ˆå±€ */
            gap: 10px; /* å…ƒç´ é–“è· */
            flex-wrap: wrap; /* å…è¨±æ›è¡Œ */
        }

        /* é–“éš”æ§åˆ¶å®¹å™¨æ¨£å¼ */
        .interval-controls {
            display: flex; /* ä½¿ç”¨å½ˆæ€§ä½ˆå±€ */
            gap: 8px; /* å…ƒç´ é–“è· */
            background: rgba(255,255,255,0.1); /* åŠé€æ˜èƒŒæ™¯ */
            padding: 8px; /* å…§é‚Šè· */
            border-radius: 15px; /* åœ“è§’ */
            margin-bottom: 15px; /* åº•éƒ¨å¤–é‚Šè· */
        }

        /* é–“éš”æ§åˆ¶æŒ‰éˆ•æ¨£å¼ */
        .interval-btn {
            background: rgba(255,255,255,0.2); /* åŠé€æ˜èƒŒæ™¯ */
            border: 1px solid rgba(255,255,255,0.3); /* åŠé€æ˜é‚Šæ¡† */
            color: white; /* æ–‡å­—é¡è‰² */
            padding: 6px 12px; /* å…§é‚Šè· */
            border-radius: 12px; /* åœ“è§’ */
            cursor: pointer; /* é¼ æ¨™æŒ‡é‡æ¨£å¼ */
            transition: all 0.3s ease; /* éæ¸¡å‹•ç•« */
            font-size: 0.9em; /* å­—é«”å¤§å° */
        }

            /* æ¿€æ´»ç‹€æ…‹çš„é–“éš”æŒ‰éˆ•æ¨£å¼ */
            .interval-btn.active {
                background: rgba(255,255,255,0.4); /* æ›´æ·±çš„èƒŒæ™¯è‰² */
                font-weight: bold; /* ç²—é«” */
            }

            /* é–“éš”æŒ‰éˆ•æ‡¸åœæ•ˆæœ */
            .interval-btn:hover {
                background: rgba(255,255,255,0.3); /* æ‡¸åœæ™‚èƒŒæ™¯è‰² */
            }

        /* åœ–è¡¨æ§åˆ¶æŒ‰éˆ•æ¨£å¼ */
        .chart-btn {
            background: rgba(255,255,255,0.2); /* åŠé€æ˜èƒŒæ™¯ */
            border: 1px solid rgba(255,255,255,0.3); /* åŠé€æ˜é‚Šæ¡† */
            color: white; /* æ–‡å­—é¡è‰² */
            padding: 8px 16px; /* å…§é‚Šè· */
            border-radius: 20px; /* åœ“è§’ */
            cursor: pointer; /* é¼ æ¨™æŒ‡é‡æ¨£å¼ */
            transition: all 0.3s ease; /* éæ¸¡å‹•ç•« */
        }

            /* æ¿€æ´»ç‹€æ…‹çš„åœ–è¡¨æŒ‰éˆ•æ¨£å¼ */
            .chart-btn.active {
                background: rgba(255,255,255,0.4); /* æ›´æ·±çš„èƒŒæ™¯è‰² */
            }

            /* åœ–è¡¨æŒ‰éˆ•æ‡¸åœæ•ˆæœ */
            .chart-btn:hover {
                background: rgba(255,255,255,0.3); /* æ‡¸åœæ™‚èƒŒæ™¯è‰² */
            }

        /* æ•¸æ“šæ—¥èªŒå®¹å™¨æ¨£å¼ */
        .data-log {
            background: rgba(0,0,0,0.2); /* åŠé€æ˜é»‘è‰²èƒŒæ™¯ */
            border-radius: 15px; /* åœ“è§’ */
            padding: 20px; /* å…§é‚Šè· */
            max-height: 300px; /* æœ€å¤§é«˜åº¦ */
            overflow-y: auto; /* å‚ç›´æ»¾å‹• */
        }

        /* æ—¥èªŒæ¢ç›®æ¨£å¼ */
        .log-entry {
            padding: 8px 12px; /* å…§é‚Šè· */
            border-bottom: 1px solid rgba(255,255,255,0.1); /* åº•éƒ¨é‚Šæ¡† */
            font-family: 'Courier New', monospace; /* ç­‰å¯¬å­—é«” */
            font-size: 0.9em; /* å­—é«”å¤§å° */
        }

        /* æ—¥èªŒæ™‚é–“æ¨£å¼ */
        .log-time {
            opacity: 0.7; /* é€æ˜åº¦ */
            margin-right: 10px; /* å³é‚Šè· */
        }

        /* æ§åˆ¶æŒ‰éˆ•å®¹å™¨æ¨£å¼ */
        .controls {
            text-align: center; /* æ–‡å­—å±…ä¸­ */
            margin: 20px 0; /* ä¸Šä¸‹å¤–é‚Šè· */
        }

        /* é€šç”¨æŒ‰éˆ•æ¨£å¼ */
        .btn {
            background: rgba(255,255,255,0.2); /* åŠé€æ˜èƒŒæ™¯ */
            border: 2px solid white; /* ç™½è‰²é‚Šæ¡† */
            color: white; /* æ–‡å­—é¡è‰² */
            padding: 12px 25px; /* å…§é‚Šè· */
            border-radius: 25px; /* åœ“è§’ */
            cursor: pointer; /* é¼ æ¨™æŒ‡é‡æ¨£å¼ */
            font-size: 1em; /* å­—é«”å¤§å° */
            margin: 0 10px; /* å·¦å³å¤–é‚Šè· */
            transition: all 0.3s ease; /* éæ¸¡å‹•ç•« */
            font-family: 'Microsoft JhengHei', Arial, sans-serif; /* å­—é«” */
        }

            /* æŒ‰éˆ•æ‡¸åœæ•ˆæœ */
            .btn:hover {
                background: rgba(255,255,255,0.3); /* æ‡¸åœæ™‚èƒŒæ™¯è‰² */
                transform: translateY(-2px); /* å‘ä¸Šç§»å‹•2åƒç´  */
            }

        /* çµ±è¨ˆæ•¸æ“šç¶²æ ¼æ¨£å¼ */
        .stats-grid {
            display: grid; /* ä½¿ç”¨ç¶²æ ¼ä½ˆå±€ */
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); /* éŸ¿æ‡‰å¼ç¶²æ ¼åˆ— */
            gap: 15px; /* ç¶²æ ¼é–“è· */
            margin: 20px 0; /* ä¸Šä¸‹å¤–é‚Šè· */
        }

        /* çµ±è¨ˆé …æ¨£å¼ */
        .stat-item {
            background: rgba(255,255,255,0.1); /* åŠé€æ˜èƒŒæ™¯ */
            padding: 15px; /* å…§é‚Šè· */
            border-radius: 15px; /* åœ“è§’ */
            text-align: center; /* æ–‡å­—å±…ä¸­ */
        }

        /* çµ±è¨ˆæ•¸å€¼æ¨£å¼ */
        .stat-value {
            font-size: 1.5em; /* å­—é«”å¤§å° */
            font-weight: bold; /* ç²—é«” */
            margin: 5px 0; /* ä¸Šä¸‹å¤–é‚Šè· */
        }

        /* ç„¡æ•¸æ“šæç¤ºæ¨£å¼ */
        .no-data {
            text-align: center; /* æ–‡å­—å±…ä¸­ */
            padding: 40px; /* å…§é‚Šè· */
            opacity: 0.7; /* é€æ˜åº¦ */
        }

        /* æ•¸æ“šä¿¡æ¯æ¨£å¼ */
        .data-info {
            margin-top: 10px; /* é ‚éƒ¨å¤–é‚Šè· */
            font-size: 0.9em; /* å­—é«”å¤§å° */
            opacity: 0.8; /* é€æ˜åº¦ */
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ - å°å±å¹•è¨­å‚™ */
        @media (max-width: 768px) {
            /* åœ¨å°å±å¹•ä¸Šå°‡ç¶²æ ¼ä½ˆå±€æ”¹ç‚ºå–®åˆ— */
            .status-bar, .real-time-cards, .stats-grid {
                grid-template-columns: 1fr;
            }

            /* åœ¨å°å±å¹•ä¸Šå°‡åœ–è¡¨é ­éƒ¨æ”¹ç‚ºå‚ç›´ä½ˆå±€ */
            .chart-header {
                flex-direction: column;
                align-items: flex-start;
            }

            /* åœ¨å°å±å¹•ä¸Šä½¿æ§åˆ¶æŒ‰éˆ•å®¹å™¨ä½”æ»¿å¯¬åº¦ä¸¦å±…ä¸­ */
            .interval-controls, .chart-controls {
                width: 100%;
                justify-content: center;
            }

            /* åœ¨å°å±å¹•ä¸Šä½¿æŒ‰éˆ•ä½”æ»¿å¯¬åº¦ä¸¦å‚ç›´æ’åˆ— */
            .btn {
                display: block;
                width: 100%;
                margin: 10px 0;
            }
        }
    </style>
</head>
<body>
    <!-- ä¸»å®¹å™¨ -->
    <div class="container">
        <!-- é é¢é ­éƒ¨ -->
        <div class="header">
            <h1>ğŸŒ¡ï¸ æº«æ¿•åº¦ç›£æ§</h1>
            <p>ESP8266</p>
        </div>

        <!-- ç‹€æ…‹æ¬„ -->
        <div class="status-bar">
            <!-- é€£æ¥ç‹€æ…‹ -->
            <div class="status-item">
                <span id="statusDot" class="status-dot disconnected"></span>
                <span id="statusText">é›¢ç·š</span>
            </div>
            <!-- è¨­å‚™ID -->
            <div class="status-item">
                ğŸ“± è¨­å‚™ID: <span id="deviceId">--</span>
            </div>
            <!-- æœ€å¾Œæ›´æ–°æ™‚é–“ -->
            <div class="status-item">
                â±ï¸ æœ€å¾Œæ›´æ–°: <span id="lastUpdate">--</span>
            </div>
            <!-- æ•¸æ“šåŒ…è¨ˆæ•¸ -->
            <div class="status-item">
                ğŸ“Š æ•¸æ“šåŒ…: <span id="packetCount">0</span>
            </div>
        </div>

        <!-- å¯¦æ™‚æ•¸æ“šå¡ç‰‡ -->
        <div class="real-time-cards">
            <!-- æº«åº¦å¡ç‰‡ -->
            <div class="card">
                <div class="card-icon">ğŸŒ¡ï¸</div>
                <div class="card-label">ç•¶å‰æº«åº¦</div>
                <div class="card-value" id="temperature">--<span class="card-unit">Â°C</span></div>
                <div id="tempTime">--</div>
            </div>

            <!-- æ¿•åº¦å¡ç‰‡ -->
            <div class="card">
                <div class="card-icon">ğŸ’§</div>
                <div class="card-label">ç•¶å‰æ¿•åº¦</div>
                <div class="card-value" id="humidity">--<span class="card-unit">%</span></div>
                <div id="humTime">--</div>
            </div>

            <!-- ä¿¡è™Ÿå¼·åº¦å¡ç‰‡ -->
            <div class="card">
                <div class="card-icon">ğŸ“¶</div>
                <div class="card-label">ä¿¡è™Ÿå¼·åº¦</div>
                <div class="card-value" id="rssi">--<span class="card-unit">dBm</span></div>
                <div>WiFiè³ªé‡</div>
            </div>
        </div>

        <!-- çµ±è¨ˆæ•¸æ“š -->
        <div class="stats-grid">
            <!-- æœ€é«˜æº«åº¦ -->
            <div class="stat-item">
                <div>ğŸ“ˆ æœ€é«˜æº«åº¦</div>
                <div class="stat-value" id="maxTemp">--Â°C</div>
                <div id="maxTempTime">--</div>
            </div>
            <!-- æœ€ä½æº«åº¦ -->
            <div class="stat-item">
                <div>ğŸ“‰ æœ€ä½æº«åº¦</div>
                <div class="stat-value" id="minTemp">--Â°C</div>
                <div id="minTempTime">--</div>
            </div>
            <!-- å¹³å‡æº«åº¦ -->
            <div class="stat-item">
                <div>ğŸ“Š å¹³å‡æº«åº¦</div>
                <div class="stat-value" id="avgTemp">--Â°C</div>
                <div>ç•¶å‰é–“éš”</div>
            </div>
            <!-- è¨˜éŒ„æ™‚é•· -->
            <div class="stat-item">
                <div>ğŸ•’ è¨˜éŒ„æ™‚é•·</div>
                <div class="stat-value" id="recordDuration">0å°æ™‚</div>
                <div>æ•¸æ“šé»: <span id="dataPoints">0</span></div>
            </div>
        </div>

        <!-- æº«åº¦åœ–è¡¨å€åŸŸ -->
        <div class="chart-container">
            <div class="chart-header">
                <h2>ğŸ“ˆ æº«åº¦è®ŠåŒ–è¶¨å‹¢</h2>
                <div class="chart-controls">
                    <!-- å°å‡ºæ•¸æ“šæŒ‰éˆ• -->
                    <button class="chart-btn" onclick="exportData()">ğŸ’¾ å°å‡ºæ•¸æ“š</button>
                    <!-- æ¸…é™¤è¨˜éŒ„æŒ‰éˆ• -->
                    <button class="chart-btn" onclick="clearHistory()">ğŸ—‘ï¸ æ¸…é™¤è¨˜éŒ„</button>
                </div>
            </div>

            <!-- é–“éš”æ§åˆ¶ -->
            <div class="interval-controls">
                <span>è¨˜éŒ„é–“éš”:</span>
                <!-- 15ç§’é–“éš”æŒ‰éˆ• -->
                <button class="interval-btn active" onclick="changeInterval('15s')">15ç§’</button>
                <!-- 30ç§’é–“éš”æŒ‰éˆ• -->
                <button class="interval-btn" onclick="changeInterval('30s')">30ç§’</button>
                <!-- 1åˆ†é˜é–“éš”æŒ‰éˆ• -->
                <button class="interval-btn" onclick="changeInterval('1m')">1åˆ†é˜</button>
                <!-- 30åˆ†é˜é–“éš”æŒ‰éˆ• -->
                <button class="interval-btn" onclick="changeInterval('30m')">30åˆ†é˜</button>
                <!-- ç•¶å‰é–“éš”ä¿¡æ¯ -->
                <span class="data-info" id="intervalInfo">ç•¶å‰: 15ç§’é–“éš”</span>
            </div>

            <!-- æº«åº¦åœ–è¡¨å®¹å™¨ -->
            <div id="tempChartWrapper">
                <canvas id="temperatureChart"></canvas>
            </div>
            <!-- ç„¡æº«åº¦æ•¸æ“šæç¤º -->
            <div id="tempNoData" class="no-data" style="display: none;">
                <p>ğŸ“Š ç­‰å¾…æº«åº¦æ•¸æ“šä¸­...</p>
                <p>è«‹ç¢ºä¿ESP8266è¨­å‚™å·²é€£æ¥ä¸¦ç™¼é€æ•¸æ“š</p>
            </div>
        </div>

        <!-- æ¿•åº¦åœ–è¡¨å€åŸŸ -->
        <div class="chart-container">
            <div class="chart-header">
                <h2>ğŸ“Š æ¿•åº¦è®ŠåŒ–è¶¨å‹¢</h2>
                <div class="chart-controls">
                    <!-- å°å‡ºæ•¸æ“šæŒ‰éˆ• -->
                    <button class="chart-btn" onclick="exportData()">ğŸ’¾ å°å‡ºæ•¸æ“š</button>
                    <!-- æ¸…é™¤è¨˜éŒ„æŒ‰éˆ• -->
                    <button class="chart-btn" onclick="clearHistory()">ğŸ—‘ï¸ æ¸…é™¤è¨˜éŒ„</button>
                </div>
            </div>

            <!-- é–“éš”æ§åˆ¶ -->
            <div class="interval-controls">
                <span>è¨˜éŒ„é–“éš”:</span>
                <!-- 15ç§’é–“éš”æŒ‰éˆ• -->
                <button class="interval-btn active" onclick="changeHumidityInterval('15s')">15ç§’</button>
                <!-- 30ç§’é–“éš”æŒ‰éˆ• -->
                <button class="interval-btn" onclick="changeHumidityInterval('30s')">30ç§’</button>
                <!-- 1åˆ†é˜é–“éš”æŒ‰éˆ• -->
                <button class="interval-btn" onclick="changeHumidityInterval('1m')">1åˆ†é˜</button>
                <!-- 30åˆ†é˜é–“éš”æŒ‰éˆ• -->
                <button class="interval-btn" onclick="changeHumidityInterval('30m')">30åˆ†é˜</button>
                <!-- ç•¶å‰é–“éš”ä¿¡æ¯ -->
                <span class="data-info" id="humidityIntervalInfo">ç•¶å‰: 15ç§’é–“éš”</span>
            </div>

            <!-- æ¿•åº¦åœ–è¡¨å®¹å™¨ -->
            <div id="humChartWrapper">
                <canvas id="humidityChart"></canvas>
            </div>
            <!-- ç„¡æ¿•åº¦æ•¸æ“šæç¤º -->
            <div id="humNoData" class="no-data" style="display: none;">
                <p>ğŸ’§ ç­‰å¾…æ¿•åº¦æ•¸æ“šä¸­...</p>
                <p>è«‹ç¢ºä¿ESP8266è¨­å‚™å·²é€£æ¥ä¸¦ç™¼é€æ•¸æ“š</p>
            </div>
        </div>

        <!-- æ§åˆ¶æŒ‰éˆ•å€åŸŸ -->
        <div class="controls">
            <!-- é€£æ¥MQTTæŒ‰éˆ• -->
            <button class="btn" onclick="connectMQTT()">ğŸ”„ é€£æ¥MQTT</button>
            <!-- è‡ªå‹•æ»¾å‹•é–‹é—œæŒ‰éˆ• -->
            <button class="btn" onclick="toggleAutoScroll()">ğŸ“œ è‡ªå‹•æ»¾å‹•: <span id="autoScrollStatus">é–‹</span></button>
        </div>

        <!-- æ•¸æ“šæ—¥èªŒå€åŸŸ -->
        <div class="data-log">
            <h3>ğŸ“‹ å¯¦æ™‚æ•¸æ“šæ—¥èªŒ</h3>
            <div id="logContainer"></div>
        </div>
    </div>

    <script>
        // MQTTè¨­å®š
        const mqttOptions = {
            hostname: 'test.mosquitto.org', // MQTTä»£ç†æœå‹™å™¨ä¸»æ©Ÿå
            port: 8081, // é€£æ¥ç«¯å£
            protocol: 'wss', // ä½¿ç”¨WebSocketå®‰å…¨å”è­°
            path: '/', // è·¯å¾‘
            reconnectPeriod: 0 // é‡é€£é–“éš”ï¼ˆ0è¡¨ç¤ºä¸è‡ªå‹•é‡é€£ï¼‰
        };

        // å…¨å±€è®Šé‡è²æ˜
        let client = null; // MQTTå®¢æˆ¶ç«¯å¯¦ä¾‹
        let isConnected = false; // é€£æ¥ç‹€æ…‹æ¨™èªŒ
        let autoScroll = true; // è‡ªå‹•æ»¾å‹•æ¨™èªŒ
        let lastDataTime = null; // æœ€å¾Œæ•¸æ“šæ¥æ”¶æ™‚é–“

        // æ•¸æ“šå­˜å„²è¨­å®š
        const MAX_STORAGE_TIME = 3 * 24 * 60 * 60 * 1000; // 3å¤©çš„æ¯«ç§’æ•¸ï¼ˆæœ€å¤§å­˜å„²æ™‚é–“ï¼‰
        let rawData = []; // å­˜å„²æ‰€æœ‰åŸå§‹æ•¸æ“šçš„æ•¸çµ„
        let displayData = { // å­˜å„²é¡¯ç¤ºæ•¸æ“šçš„å°è±¡
            temperature: [], // æº«åº¦æ•¸æ“šæ•¸çµ„
            humidity: [] // æ¿•åº¦æ•¸æ“šæ•¸çµ„
        };

        // é–“éš”è¨­å®š - å·²ä¿®æ”¹ç‚º15ç§’ã€30ç§’ã€1åˆ†é˜ã€30åˆ†é˜
        const intervals = {
            '15s': { ms: 15 * 1000, name: '15ç§’' }, // 15ç§’é–“éš”è¨­å®š
            '30s': { ms: 30 * 1000, name: '30ç§’' }, // 30ç§’é–“éš”è¨­å®š
            '1m': { ms: 60 * 1000, name: '1åˆ†é˜' }, // 1åˆ†é˜é–“éš”è¨­å®š
            '30m': { ms: 30 * 60 * 1000, name: '30åˆ†é˜' } // 30åˆ†é˜é–“éš”è¨­å®š
        };

        // ç•¶å‰è¨­ç½®çš„é–“éš”
        let currentInterval = '15s'; // ç•¶å‰æº«åº¦åœ–è¡¨é–“éš”
        let currentHumidityInterval = '15s'; // ç•¶å‰æ¿•åº¦åœ–è¡¨é–“éš”
        let currentTimeRange = 72; // ç•¶å‰æ™‚é–“ç¯„åœï¼ˆå°æ™‚ï¼‰- ä¿æŒ3å¤©ä½œç‚ºé»˜èªæ™‚é–“ç¯„åœ

        // Chart.js å¯¦ä¾‹
        let temperatureChart = null; // æº«åº¦åœ–è¡¨å¯¦ä¾‹
        let humidityChart = null; // æ¿•åº¦åœ–è¡¨å¯¦ä¾‹

        // DOMå…ƒç´ å¼•ç”¨
        const statusDot = document.getElementById('statusDot'); // ç‹€æ…‹æŒ‡ç¤ºé»å…ƒç´ 
        const statusText = document.getElementById('statusText'); // ç‹€æ…‹æ–‡æœ¬å…ƒç´ 
        const temperatureElement = document.getElementById('temperature'); // æº«åº¦é¡¯ç¤ºå…ƒç´ 
        const humidityElement = document.getElementById('humidity'); // æ¿•åº¦é¡¯ç¤ºå…ƒç´ 
        const rssiElement = document.getElementById('rssi'); // ä¿¡è™Ÿå¼·åº¦é¡¯ç¤ºå…ƒç´ 
        const deviceIdElement = document.getElementById('deviceId'); // è¨­å‚™IDé¡¯ç¤ºå…ƒç´ 
        const lastUpdateElement = document.getElementById('lastUpdate'); // æœ€å¾Œæ›´æ–°æ™‚é–“é¡¯ç¤ºå…ƒç´ 
        const packetCountElement = document.getElementById('packetCount'); // æ•¸æ“šåŒ…è¨ˆæ•¸é¡¯ç¤ºå…ƒç´ 
        const logContainer = document.getElementById('logContainer'); // æ—¥èªŒå®¹å™¨å…ƒç´ 
        const autoScrollStatus = document.getElementById('autoScrollStatus'); // è‡ªå‹•æ»¾å‹•ç‹€æ…‹é¡¯ç¤ºå…ƒç´ 
        const tempTimeElement = document.getElementById('tempTime'); // æº«åº¦æ›´æ–°æ™‚é–“é¡¯ç¤ºå…ƒç´ 
        const humTimeElement = document.getElementById('humTime'); // æ¿•åº¦æ›´æ–°æ™‚é–“é¡¯ç¤ºå…ƒç´ 
        const intervalInfo = document.getElementById('intervalInfo'); // é–“éš”ä¿¡æ¯é¡¯ç¤ºå…ƒç´ 
        const humidityIntervalInfo = document.getElementById('humidityIntervalInfo'); // æ¿•åº¦é–“éš”ä¿¡æ¯é¡¯ç¤ºå…ƒç´ 

        // çµ±è¨ˆå…ƒç´ å¼•ç”¨
        const maxTempElement = document.getElementById('maxTemp'); // æœ€é«˜æº«åº¦é¡¯ç¤ºå…ƒç´ 
        const minTempElement = document.getElementById('minTemp'); // æœ€ä½æº«åº¦é¡¯ç¤ºå…ƒç´ 
        const avgTempElement = document.getElementById('avgTemp'); // å¹³å‡æº«åº¦é¡¯ç¤ºå…ƒç´ 
        const recordDurationElement = document.getElementById('recordDuration'); // è¨˜éŒ„æ™‚é•·é¡¯ç¤ºå…ƒç´ 
        const dataPointsElement = document.getElementById('dataPoints'); // æ•¸æ“šé»æ•¸é¡¯ç¤ºå…ƒç´ 
        const maxTempTimeElement = document.getElementById('maxTempTime'); // æœ€é«˜æº«åº¦æ™‚é–“é¡¯ç¤ºå…ƒç´ 
        const minTempTimeElement = document.getElementById('minTempTime'); // æœ€ä½æº«åº¦æ™‚é–“é¡¯ç¤ºå…ƒç´ 

        // åˆå§‹åŒ–åœ–è¡¨å‡½æ•¸
        function initializeCharts() {
            try {
                // ç²å–åœ–è¡¨canvaså…ƒç´ 
                const tempCtx = document.getElementById('temperatureChart');
                const humCtx = document.getElementById('humidityChart');

                // æª¢æŸ¥canvaså…ƒç´ æ˜¯å¦å­˜åœ¨
                if (!tempCtx || !humCtx) {
                    console.error('åœ–è¡¨canvaså…ƒç´ æœªæ‰¾åˆ°');
                    return;
                }

                // å‰µå»ºæº«åº¦åœ–è¡¨
                temperatureChart = new Chart(tempCtx.getContext('2d'), {
                    type: 'line', // åœ–è¡¨é¡å‹ç‚ºæŠ˜ç·šåœ–
                    data: {
                        datasets: [{ // æ•¸æ“šé›†é…ç½®
                            label: 'æº«åº¦ (Â°C)', // æ•¸æ“šé›†æ¨™ç±¤
                            data: [], // åˆå§‹æ•¸æ“šç‚ºç©ºæ•¸çµ„
                            borderColor: '#FF6B6B', // é‚Šæ¡†é¡è‰²
                            backgroundColor: 'rgba(255, 107, 107, 0.1)', // èƒŒæ™¯é¡è‰²
                            borderWidth: 2, // é‚Šæ¡†å¯¬åº¦
                            fill: true, // å¡«å……å€åŸŸ
                            tension: 0.4, // ç·šæ¢å¼µåŠ›ï¼ˆæ›²ç·šç¨‹åº¦ï¼‰
                            pointRadius: 2, // æ•¸æ“šé»åŠå¾‘
                            pointHoverRadius: 5 // æ‡¸åœæ™‚æ•¸æ“šé»åŠå¾‘
                        }]
                    },
                    options: { // åœ–è¡¨é¸é …
                        responsive: true, // éŸ¿æ‡‰å¼è¨­è¨ˆ
                        maintainAspectRatio: false, // ä¸ä¿æŒç¸±æ©«æ¯”
                        scales: { // åæ¨™è»¸é…ç½®
                            x: { // Xè»¸é…ç½®
                                type: 'time', // æ™‚é–“é¡å‹
                                time: { // æ™‚é–“é…ç½®
                                    unit: 'hour', // æ™‚é–“å–®ä½
                                    tooltipFormat: 'MMæœˆddæ—¥ HH:mm', // å·¥å…·æç¤ºæ ¼å¼
                                    displayFormats: { // é¡¯ç¤ºæ ¼å¼
                                        hour: 'MMæœˆddæ—¥ HH:mm' // å°æ™‚ç´šåˆ¥é¡¯ç¤ºæ ¼å¼
                                    }
                                },
                                title: { // æ¨™é¡Œé…ç½®
                                    display: true, // é¡¯ç¤ºæ¨™é¡Œ
                                    text: 'æ™‚é–“', // æ¨™é¡Œæ–‡æœ¬
                                    color: 'white' // æ¨™é¡Œé¡è‰²
                                },
                                ticks: { // åˆ»åº¦é…ç½®
                                    color: 'white', // åˆ»åº¦é¡è‰²
                                    maxTicksLimit: 8 // æœ€å¤§åˆ»åº¦æ•¸é‡é™åˆ¶
                                }
                            },
                            y: { // Yè»¸é…ç½®
                                title: { // æ¨™é¡Œé…ç½®
                                    display: true, // é¡¯ç¤ºæ¨™é¡Œ
                                    text: 'æº«åº¦ (Â°C)', // æ¨™é¡Œæ–‡æœ¬
                                    color: 'white' // æ¨™é¡Œé¡è‰²
                                },
                                ticks: { // åˆ»åº¦é…ç½®
                                    color: 'white' // åˆ»åº¦é¡è‰²
                                },
                                suggestedMin: 15, // å»ºè­°æœ€å°å€¼
                                suggestedMax: 35 // å»ºè­°æœ€å¤§å€¼
                            }
                        },
                        plugins: { // æ’ä»¶é…ç½®
                            legend: { // åœ–ä¾‹é…ç½®
                                labels: { // æ¨™ç±¤é…ç½®
                                    color: 'white' // æ¨™ç±¤é¡è‰²
                                }
                            },
                            tooltip: { // å·¥å…·æç¤ºé…ç½®
                                mode: 'index', // æ¨¡å¼ç‚ºç´¢å¼•
                                intersect: false, // ä¸è¦æ±‚é¼ æ¨™ç²¾ç¢ºæ‡¸åœåœ¨å…ƒç´ ä¸Š
                                backgroundColor: 'rgba(0, 0, 0, 0.8)' // èƒŒæ™¯é¡è‰²
                            }
                        }
                    }
                });

                // å‰µå»ºæ¿•åº¦åœ–è¡¨
                humidityChart = new Chart(humCtx.getContext('2d'), {
                    type: 'line', // åœ–è¡¨é¡å‹ç‚ºæŠ˜ç·šåœ–
                    data: {
                        datasets: [{ // æ•¸æ“šé›†é…ç½®
                            label: 'æ¿•åº¦ (%)', // æ•¸æ“šé›†æ¨™ç±¤
                            data: [], // åˆå§‹æ•¸æ“šç‚ºç©ºæ•¸çµ„
                            borderColor: '#4D96FF', // é‚Šæ¡†é¡è‰²
                            backgroundColor: 'rgba(77, 150, 255, 0.1)', // èƒŒæ™¯é¡è‰²
                            borderWidth: 2, // é‚Šæ¡†å¯¬åº¦
                            fill: true, // å¡«å……å€åŸŸ
                            tension: 0.4, // ç·šæ¢å¼µåŠ›ï¼ˆæ›²ç·šç¨‹åº¦ï¼‰
                            pointRadius: 2, // æ•¸æ“šé»åŠå¾‘
                            pointHoverRadius: 5 // æ‡¸åœæ™‚æ•¸æ“šé»åŠå¾‘
                        }]
                    },
                    options: { // åœ–è¡¨é¸é …
                        responsive: true, // éŸ¿æ‡‰å¼è¨­è¨ˆ
                        maintainAspectRatio: false, // ä¸ä¿æŒç¸±æ©«æ¯”
                        scales: { // åæ¨™è»¸é…ç½®
                            x: { // Xè»¸é…ç½®
                                type: 'time', // æ™‚é–“é¡å‹
                                time: { // æ™‚é–“é…ç½®
                                    unit: 'hour', // æ™‚é–“å–®ä½
                                    tooltipFormat: 'MMæœˆddæ—¥ HH:mm', // å·¥å…·æç¤ºæ ¼å¼
                                    displayFormats: { // é¡¯ç¤ºæ ¼å¼
                                        hour: 'MMæœˆddæ—¥ HH:mm' // å°æ™‚ç´šåˆ¥é¡¯ç¤ºæ ¼å¼
                                    }
                                },
                                title: { // æ¨™é¡Œé…ç½®
                                    display: true, // é¡¯ç¤ºæ¨™é¡Œ
                                    text: 'æ™‚é–“', // æ¨™é¡Œæ–‡æœ¬
                                    color: 'white' // æ¨™é¡Œé¡è‰²
                                },
                                ticks: { // åˆ»åº¦é…ç½®
                                    color: 'white', // åˆ»åº¦é¡è‰²
                                    maxTicksLimit: 8 // æœ€å¤§åˆ»åº¦æ•¸é‡é™åˆ¶
                                }
                            },
                            y: { // Yè»¸é…ç½®
                                title: { // æ¨™é¡Œé…ç½®
                                    display: true, // é¡¯ç¤ºæ¨™é¡Œ
                                    text: 'æ¿•åº¦ (%)', // æ¨™é¡Œæ–‡æœ¬
                                    color: 'white' // æ¨™é¡Œé¡è‰²
                                },
                                ticks: { // åˆ»åº¦é…ç½®
                                    color: 'white' // åˆ»åº¦é¡è‰²
                                },
                                suggestedMin: 30, // å»ºè­°æœ€å°å€¼
                                suggestedMax: 80 // å»ºè­°æœ€å¤§å€¼
                            }
                        },
                        plugins: { // æ’ä»¶é…ç½®
                            legend: { // åœ–ä¾‹é…ç½®
                                labels: { // æ¨™ç±¤é…ç½®
                                    color: 'white' // æ¨™ç±¤é¡è‰²
                                }
                            },
                            tooltip: { // å·¥å…·æç¤ºé…ç½®
                                mode: 'index', // æ¨¡å¼ç‚ºç´¢å¼•
                                intersect: false, // ä¸è¦æ±‚é¼ æ¨™ç²¾ç¢ºæ‡¸åœåœ¨å…ƒç´ ä¸Š
                                backgroundColor: 'rgba(0, 0, 0, 0.8)' // èƒŒæ™¯é¡è‰²
                            }
                        }
                    }
                });

                console.log('åœ–è¡¨åˆå§‹åŒ–æˆåŠŸ');

            } catch (error) {
                // éŒ¯èª¤è™•ç†
                console.error('åœ–è¡¨åˆå§‹åŒ–å¤±æ•—:', error);
                addLog('âŒ åœ–è¡¨åˆå§‹åŒ–å¤±æ•—: ' + error.message);
            }
        }

        // æ·»åŠ åŸå§‹æ•¸æ“šé»å‡½æ•¸
        function addRawDataPoint(temperature, humidity) {
            try {
                // ç²å–ç•¶å‰æ™‚é–“
                const now = new Date();
                const timestamp = now.getTime(); // ç²å–æ™‚é–“æˆ³

                // æ·»åŠ æ–°æ•¸æ“šåˆ°åŸå§‹æ•¸æ“šæ•¸çµ„
                rawData.push({
                    timestamp: timestamp, // æ™‚é–“æˆ³
                    temperature: parseFloat(temperature), // è½‰æ›ç‚ºæµ®é»æ•¸çš„æº«åº¦
                    humidity: parseFloat(humidity) // è½‰æ›ç‚ºæµ®é»æ•¸çš„æ¿•åº¦
                });

                // æ¸…ç†è¶…é3å¤©çš„èˆŠæ•¸æ“š
                const cutoffTime = Date.now() - MAX_STORAGE_TIME; // è¨ˆç®—æˆªæ­¢æ™‚é–“
                rawData = rawData.filter(point => point.timestamp >= cutoffTime); // éæ¿¾æ‰èˆŠæ•¸æ“š

                // æ›´æ–°é¡¯ç¤ºæ•¸æ“š
                updateDisplayData();

                // æ›´æ–°çµ±è¨ˆä¿¡æ¯
                updateStatistics();

            } catch (error) {
                // éŒ¯èª¤è™•ç†
                console.error('æ·»åŠ æ•¸æ“šé»éŒ¯èª¤:', error);
                addLog('âŒ æ·»åŠ æ•¸æ“šé»éŒ¯èª¤: ' + error.message);
            }
        }

        // æ ¹æ“šé–“éš”æ›´æ–°é¡¯ç¤ºæ•¸æ“šå‡½æ•¸
        function updateDisplayData() {
            // å¦‚æœæ²’æœ‰æ•¸æ“šå‰‡è¿”å›
            if (rawData.length === 0) return;

            // æ›´æ–°æº«åº¦é¡¯ç¤ºæ•¸æ“š
            displayData.temperature = aggregateData(rawData, 'temperature', currentInterval);

            // æ›´æ–°æ¿•åº¦é¡¯ç¤ºæ•¸æ“š
            displayData.humidity = aggregateData(rawData, 'humidity', currentHumidityInterval);

            // æ›´æ–°åœ–è¡¨
            updateCharts();
        }

        // æ•¸æ“šèšåˆå‡½æ•¸
        function aggregateData(data, field, interval) {
            // å¦‚æœæ²’æœ‰æ•¸æ“šå‰‡è¿”å›ç©ºæ•¸çµ„
            if (data.length === 0) return [];

            // ç²å–é–“éš”çš„æ¯«ç§’æ•¸
            const intervalMs = intervals[interval].ms;
            const aggregated = []; // èšåˆæ•¸æ“šæ•¸çµ„
            let currentBucket = null; // ç•¶å‰æ•¸æ“šæ¡¶

            // æŒ‰æ™‚é–“é–“éš”åˆ†çµ„ä¸¦è¨ˆç®—å¹³å‡å€¼
            data.forEach(point => {
                // è¨ˆç®—ç•¶å‰æ•¸æ“šé»æ‰€å±¬çš„æ™‚é–“æ¡¶
                const bucketTime = Math.floor(point.timestamp / intervalMs) * intervalMs;

                // å¦‚æœç•¶å‰æ¡¶ä¸å­˜åœ¨æˆ–æ™‚é–“ä¸åŒ¹é…ï¼Œå‰‡å‰µå»ºæ–°æ¡¶
                if (!currentBucket || currentBucket.timestamp !== bucketTime) {
                    // å¦‚æœå­˜åœ¨ç•¶å‰æ¡¶ï¼Œå‰‡å°‡å…¶æ·»åŠ åˆ°èšåˆæ•¸çµ„
                    if (currentBucket) {
                        aggregated.push(currentBucket);
                    }
                    // å‰µå»ºæ–°æ¡¶
                    currentBucket = {
                        timestamp: bucketTime, // æ¡¶çš„æ™‚é–“æˆ³
                        values: [point[field]] // æ¡¶ä¸­çš„å€¼æ•¸çµ„
                    };
                } else {
                    // å¦‚æœç•¶å‰æ¡¶å­˜åœ¨ä¸”æ™‚é–“åŒ¹é…ï¼Œå‰‡å°‡å€¼æ·»åŠ åˆ°æ¡¶ä¸­
                    currentBucket.values.push(point[field]);
                }
            });

            // æ·»åŠ æœ€å¾Œä¸€å€‹æ¡¶åˆ°èšåˆæ•¸çµ„
            if (currentBucket) {
                aggregated.push(currentBucket);
            }

            // è½‰æ›ç‚ºåœ–è¡¨æ•¸æ“šæ ¼å¼ä¸¦è¨ˆç®—å¹³å‡å€¼
            return aggregated.map(bucket => ({
                x: bucket.timestamp, // Xè»¸å€¼ï¼ˆæ™‚é–“æˆ³ï¼‰
                y: bucket.values.reduce((sum, val) => sum + val, 0) / bucket.values.length // Yè»¸å€¼ï¼ˆå¹³å‡å€¼ï¼‰
            }));
        }

        // æ”¹è®Šè¨˜éŒ„é–“éš”å‡½æ•¸
        function changeInterval(interval) {
            // æ›´æ–°ç•¶å‰é–“éš”
            currentInterval = interval;
            // æ›´æ–°é–“éš”ä¿¡æ¯é¡¯ç¤º
            intervalInfo.textContent = `ç•¶å‰: ${intervals[interval].name}é–“éš”`;

            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            updateIntervalButtons('interval', interval);

            // æ›´æ–°é¡¯ç¤ºæ•¸æ“š
            updateDisplayData();
        }

        // æ”¹è®Šæ¿•åº¦è¨˜éŒ„é–“éš”å‡½æ•¸
        function changeHumidityInterval(interval) {
            // æ›´æ–°ç•¶å‰æ¿•åº¦é–“éš”
            currentHumidityInterval = interval;
            // æ›´æ–°æ¿•åº¦é–“éš”ä¿¡æ¯é¡¯ç¤º
            humidityIntervalInfo.textContent = `ç•¶å‰: ${intervals[interval].name}é–“éš”`;

            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            updateIntervalButtons('humidityInterval', interval);

            // æ›´æ–°é¡¯ç¤ºæ•¸æ“š
            updateDisplayData();
        }

        // æ›´æ–°é–“éš”æŒ‰éˆ•ç‹€æ…‹å‡½æ•¸
        function updateIntervalButtons(type, activeInterval) {
            // ç²å–æ‰€æœ‰é–“éš”æŒ‰éˆ•
            const buttons = document.querySelectorAll(`.interval-controls .interval-btn`);
            // éæ­·æ‰€æœ‰æŒ‰éˆ•
            buttons.forEach(btn => {
                // å°‡é–“éš”ä»£ç¢¼è½‰æ›ç‚ºé¡¯ç¤ºæ–‡æœ¬
                const intervalText = activeInterval.replace('s', 'ç§’').replace('m', 'åˆ†é˜').replace('h', 'å°æ™‚');
                // å¦‚æœæŒ‰éˆ•æ–‡æœ¬èˆ‡æ´»å‹•é–“éš”åŒ¹é…ï¼Œå‰‡æ·»åŠ activeé¡ï¼Œå¦å‰‡ç§»é™¤
                if (btn.textContent === intervalText) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        // æ›´æ–°åœ–è¡¨å‡½æ•¸
        function updateCharts() {
            try {
                // å¦‚æœåœ–è¡¨æœªåˆå§‹åŒ–å‰‡è¿”å›
                if (!temperatureChart || !humidityChart) return;

                // è¨ˆç®—æ™‚é–“ç¯„åœæˆªæ­¢é»
                const cutoffTime = Date.now() - (currentTimeRange * 60 * 60 * 1000);

                // éæ¿¾æº«åº¦æ•¸æ“šï¼Œåªä¿ç•™åœ¨æ™‚é–“ç¯„åœå…§çš„æ•¸æ“š
                const filteredTempData = displayData.temperature.filter(point => point.x >= cutoffTime);
                // éæ¿¾æ¿•åº¦æ•¸æ“šï¼Œåªä¿ç•™åœ¨æ™‚é–“ç¯„åœå…§çš„æ•¸æ“š
                const filteredHumData = displayData.humidity.filter(point => point.x >= cutoffTime);

                // æ›´æ–°æº«åº¦åœ–è¡¨æ•¸æ“š
                if (temperatureChart.data && temperatureChart.data.datasets) {
                    temperatureChart.data.datasets[0].data = filteredTempData;
                    temperatureChart.update('none'); // æ›´æ–°åœ–è¡¨ä½†ä¸ä½¿ç”¨å‹•ç•«
                }

                // æ›´æ–°æ¿•åº¦åœ–è¡¨æ•¸æ“š
                if (humidityChart.data && humidityChart.data.datasets) {
                    humidityChart.data.datasets[0].data = filteredHumData;
                    humidityChart.update('none'); // æ›´æ–°åœ–è¡¨ä½†ä¸ä½¿ç”¨å‹•ç•«
                }

                // æ›´æ–°åœ–è¡¨å¯è¦‹æ€§
                updateChartVisibility();

            } catch (error) {
                // éŒ¯èª¤è™•ç†
                console.error('æ›´æ–°åœ–è¡¨éŒ¯èª¤:', error);
            }
        }

        // æ›´æ–°åœ–è¡¨é¡¯ç¤ºç‹€æ…‹å‡½æ•¸
        function updateChartVisibility() {
            // ç²å–ç›¸é—œDOMå…ƒç´ 
            const tempNoData = document.getElementById('tempNoData');
            const humNoData = document.getElementById('humNoData');
            const tempChartWrapper = document.getElementById('tempChartWrapper');
            const humChartWrapper = document.getElementById('humChartWrapper');

            // æ ¹æ“šæ˜¯å¦æœ‰æº«åº¦æ•¸æ“šä¾†é¡¯ç¤º/éš±è—åœ–è¡¨å’Œç„¡æ•¸æ“šæç¤º
            if (displayData.temperature.length > 0) {
                tempNoData.style.display = 'none'; // éš±è—ç„¡æ•¸æ“šæç¤º
                tempChartWrapper.style.display = 'block'; // é¡¯ç¤ºåœ–è¡¨
            } else {
                tempNoData.style.display = 'block'; // é¡¯ç¤ºç„¡æ•¸æ“šæç¤º
                tempChartWrapper.style.display = 'none'; // éš±è—åœ–è¡¨
            }

            // æ ¹æ“šæ˜¯å¦æœ‰æ¿•åº¦æ•¸æ“šä¾†é¡¯ç¤º/éš±è—åœ–è¡¨å’Œç„¡æ•¸æ“šæç¤º
            if (displayData.humidity.length > 0) {
                humNoData.style.display = 'none'; // éš±è—ç„¡æ•¸æ“šæç¤º
                humChartWrapper.style.display = 'block'; // é¡¯ç¤ºåœ–è¡¨
            } else {
                humNoData.style.display = 'block'; // é¡¯ç¤ºç„¡æ•¸æ“šæç¤º
                humChartWrapper.style.display = 'none'; // éš±è—åœ–è¡¨
            }
        }

        // æ›´æ–°çµ±è¨ˆä¿¡æ¯å‡½æ•¸
        function updateStatistics() {
            try {
                // å¦‚æœæ²’æœ‰æ•¸æ“šï¼Œå‰‡è¨­ç½®é»˜èªå€¼
                if (rawData.length === 0) {
                    maxTempElement.textContent = '--Â°C'; // æœ€é«˜æº«åº¦
                    minTempElement.textContent = '--Â°C'; // æœ€ä½æº«åº¦
                    avgTempElement.textContent = '--Â°C'; // å¹³å‡æº«åº¦
                    recordDurationElement.textContent = '0å°æ™‚'; // è¨˜éŒ„æ™‚é•·
                    dataPointsElement.textContent = '0'; // æ•¸æ“šé»æ•¸
                    maxTempTimeElement.textContent = '--'; // æœ€é«˜æº«åº¦æ™‚é–“
                    minTempTimeElement.textContent = '--'; // æœ€ä½æº«åº¦æ™‚é–“
                    return;
                }

                // è¨ˆç®—ç•¶å‰é–“éš”å…§çš„çµ±è¨ˆæ•¸æ“š
                const cutoffTime = Date.now() - intervals[currentInterval].ms; // è¨ˆç®—æˆªæ­¢æ™‚é–“
                const recentData = rawData.filter(point => point.timestamp >= cutoffTime); // éæ¿¾è¿‘æœŸæ•¸æ“š

                // å¦‚æœæœ‰è¿‘æœŸæ•¸æ“šï¼Œå‰‡è¨ˆç®—çµ±è¨ˆå€¼
                if (recentData.length > 0) {
                    const temps = recentData.map(point => point.temperature); // æå–æº«åº¦å€¼
                    const maxTemp = Math.max(...temps); // è¨ˆç®—æœ€é«˜æº«åº¦
                    const minTemp = Math.min(...temps); // è¨ˆç®—æœ€ä½æº«åº¦
                    const avgTemp = (temps.reduce((a, b) => a + b, 0) / temps.length).toFixed(1); // è¨ˆç®—å¹³å‡æº«åº¦

                    // æ›´æ–°é¡¯ç¤ºå…ƒç´ 
                    maxTempElement.textContent = maxTemp.toFixed(1) + 'Â°C';
                    minTempElement.textContent = minTemp.toFixed(1) + 'Â°C';
                    avgTempElement.textContent = avgTemp + 'Â°C';
                }

                // è¨ˆç®—ç¸½é«”çµ±è¨ˆæ•¸æ“š
                const allTemps = rawData.map(point => point.temperature); // æå–æ‰€æœ‰æº«åº¦å€¼
                const overallMaxTemp = Math.max(...allTemps); // ç¸½é«”æœ€é«˜æº«åº¦
                const overallMinTemp = Math.min(...allTemps); // ç¸½é«”æœ€ä½æº«åº¦

                // æ‰¾åˆ°æœ€é«˜å’Œæœ€ä½æº«åº¦çš„æ™‚é–“é»
                const maxTempPoint = rawData.find(point => point.temperature === overallMaxTemp);
                const minTempPoint = rawData.find(point => point.temperature === overallMinTemp);

                // æ›´æ–°æœ€é«˜æº«åº¦æ™‚é–“é¡¯ç¤º
                if (maxTempPoint) {
                    maxTempTimeElement.textContent = new Date(maxTempPoint.timestamp).toLocaleString('zh-TW');
                }
                // æ›´æ–°æœ€ä½æº«åº¦æ™‚é–“é¡¯ç¤º
                if (minTempPoint) {
                    minTempTimeElement.textContent = new Date(minTempPoint.timestamp).toLocaleString('zh-TW');
                }

                // æ›´æ–°è¨˜éŒ„æ™‚é•·
                if (rawData.length > 1) {
                    const duration = (rawData[rawData.length - 1].timestamp - rawData[0].timestamp) / (1000 * 60 * 60); // è¨ˆç®—æ™‚é•·ï¼ˆå°æ™‚ï¼‰
                    recordDurationElement.textContent = duration.toFixed(1) + 'å°æ™‚'; // æ›´æ–°é¡¯ç¤º
                }

                // æ›´æ–°æ•¸æ“šé»æ•¸é¡¯ç¤º
                dataPointsElement.textContent = rawData.length;

            } catch (error) {
                // éŒ¯èª¤è™•ç†
                console.error('æ›´æ–°çµ±è¨ˆä¿¡æ¯éŒ¯èª¤:', error);
            }
        }

        // å°å‡ºæ•¸æ“šå‡½æ•¸
        function exportData() {
            try {
                // å¦‚æœæ²’æœ‰æ•¸æ“šå‰‡æç¤ºç”¨æˆ¶
                if (rawData.length === 0) {
                    alert('æ²’æœ‰æ•¸æ“šå¯å°å‡º');
                    return;
                }

                // å°‡æ•¸æ“šè½‰æ›ç‚ºCSVæ ¼å¼
                const csv = rawData.map(point => {
                    const date = new Date(point.timestamp); // å‰µå»ºæ—¥æœŸå°è±¡
                    return `${date.toLocaleString('zh-TW')},${point.temperature},${point.humidity}`; // æ ¼å¼åŒ–æ¯è¡Œæ•¸æ“š
                }).join('\n'); // ç”¨æ›è¡Œç¬¦é€£æ¥æ‰€æœ‰è¡Œ

                // å‰µå»ºCSVæ–‡ä»¶çš„Blobå°è±¡
                const blob = new Blob(['æ™‚é–“,æº«åº¦(Â°C),æ¿•åº¦(%)\n' + csv], { type: 'text/csv;charset=utf-8;' });
                // å‰µå»ºBlob URL
                const url = URL.createObjectURL(blob);
                // å‰µå»ºä¸‹è¼‰éˆæ¥
                const a = document.createElement('a');
                a.href = url; // è¨­ç½®éˆæ¥åœ°å€
                a.download = `temperature_humidity_data_${new Date().toISOString().split('T')[0]}.csv`; // è¨­ç½®æ–‡ä»¶å
                document.body.appendChild(a); // å°‡éˆæ¥æ·»åŠ åˆ°æ–‡æª”
                a.click(); // æ¨¡æ“¬é»æ“Šä¸‹è¼‰
                document.body.removeChild(a); // ç§»é™¤éˆæ¥
                URL.revokeObjectURL(url); // é‡‹æ”¾Blob URL

                // æ·»åŠ æ—¥èªŒè¨˜éŒ„
                addLog('ğŸ’¾ æ•¸æ“šå·²å°å‡ºç‚ºCSVæ–‡ä»¶');

            } catch (error) {
                // éŒ¯èª¤è™•ç†
                console.error('å°å‡ºæ•¸æ“šéŒ¯èª¤:', error);
                addLog('âŒ å°å‡ºæ•¸æ“šå¤±æ•—: ' + error.message);
            }
        }

        // æ¸…é™¤æ­·å²è¨˜éŒ„å‡½æ•¸
        function clearHistory() {
            try {
                // ç¢ºèªç”¨æˆ¶æ˜¯å¦çœŸçš„è¦æ¸…é™¤æ­·å²è¨˜éŒ„
                if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰æ­·å²è¨˜éŒ„å—ï¼Ÿ')) {
                    // æ¸…ç©ºæ‰€æœ‰æ•¸æ“š
                    rawData = [];
                    displayData = { temperature: [], humidity: [] };
                    // æ›´æ–°åœ–è¡¨å¯è¦‹æ€§
                    updateChartVisibility();
                    // æ›´æ–°åœ–è¡¨
                    updateCharts();
                    // æ›´æ–°çµ±è¨ˆä¿¡æ¯
                    updateStatistics();
                    // æ·»åŠ æ—¥èªŒè¨˜éŒ„
                    addLog('ğŸ—‘ï¸ æ­·å²è¨˜éŒ„å·²æ¸…é™¤');
                }
            } catch (error) {
                // éŒ¯èª¤è™•ç†
                console.error('æ¸…é™¤æ­·å²è¨˜éŒ„éŒ¯èª¤:', error);
            }
        }

        // MQTTé€£æ¥å‡½æ•¸
        function connectMQTT() {
            // å¦‚æœå·²ç¶“é€£æ¥ï¼Œå‰‡æç¤ºç”¨æˆ¶
            if (isConnected) {
                addLog('âš ï¸ å·²ç¶“é€£æ¥åˆ°MQTTæœå‹™å™¨');
                return;
            }

            // æ›´æ–°é€£æ¥ç‹€æ…‹ç‚º"é€£æ¥ä¸­"
            updateStatus('connecting', 'æ­£åœ¨é€£æ¥ Mosquitto...');
            addLog('ğŸ”— æ­£åœ¨é€£æ¥ MQTT æœå‹™å™¨: ' + mqttOptions.hostname);

            try {
                // å‰µå»ºMQTTå®¢æˆ¶ç«¯ä¸¦é€£æ¥
                client = mqtt.connect(mqttOptions);

                // é€£æ¥æˆåŠŸå›èª¿
                client.on('connect', function () {
                    isConnected = true; // è¨­ç½®é€£æ¥ç‹€æ…‹ç‚ºå·²é€£æ¥
                    updateStatus('connected', 'å·²é€£æ¥åˆ° Mosquitto'); // æ›´æ–°ç‹€æ…‹é¡¯ç¤º
                    addLog('âœ… MQTTé€£æ¥æˆåŠŸ'); // æ·»åŠ æ—¥èªŒè¨˜éŒ„

                    // è¨‚é–±æº«åº¦æ¿•åº¦ä¸»é¡Œ
                    client.subscribe('home/sensor/temperature_humidity', function (err) {
                        if (!err) {
                            addLog('ğŸ“¡ å·²è¨‚é–±æº«åº¦æ¿•åº¦ä¸»é¡Œ'); // è¨‚é–±æˆåŠŸ
                        } else {
                            addLog('âŒ è¨‚é–±å¤±æ•—: ' + err.message); // è¨‚é–±å¤±æ•—
                        }
                    });
                });

                // æ”¶åˆ°æ¶ˆæ¯å›èª¿
                client.on('message', function (topic, message) {
                    try {
                        // è§£ææ”¶åˆ°çš„JSONæ•¸æ“š
                        const data = JSON.parse(message.toString());
                        // æ›´æ–°é¡¯ç¤º
                        updateDisplay(data);
                        // æ·»åŠ åŸå§‹æ•¸æ“šé»
                        addRawDataPoint(data.temperature, data.humidity);
                        // æ›´æ–°æœ€å¾Œæ•¸æ“šæ¥æ”¶æ™‚é–“
                        lastDataTime = new Date();

                    } catch (e) {
                        // è§£æéŒ¯èª¤è™•ç†
                        addLog('âŒ è§£ææ•¸æ“šéŒ¯èª¤: ' + e.message);
                    }
                });

                // éŒ¯èª¤å›èª¿
                client.on('error', function (err) {
                    updateStatus('disconnected', 'é€£æ¥éŒ¯èª¤: ' + err.message); // æ›´æ–°ç‹€æ…‹é¡¯ç¤º
                    addLog('âŒ MQTTéŒ¯èª¤: ' + err.message); // æ·»åŠ æ—¥èªŒè¨˜éŒ„
                });

                // é€£æ¥é—œé–‰å›èª¿
                client.on('close', function () {
                    isConnected = false; // è¨­ç½®é€£æ¥ç‹€æ…‹ç‚ºæœªé€£æ¥
                    updateStatus('disconnected', 'é€£æ¥å·²æ–·é–‹'); // æ›´æ–°ç‹€æ…‹é¡¯ç¤º
                    addLog('ğŸ”Œ MQTTé€£æ¥å·²é—œé–‰'); // æ·»åŠ æ—¥èªŒè¨˜éŒ„
                });

            } catch (error) {
                // é€£æ¥å¤±æ•—è™•ç†
                addLog('âŒ é€£æ¥å¤±æ•—: ' + error.message);
                updateStatus('disconnected', 'é€£æ¥å¤±æ•—');
            }
        }

        // æ›´æ–°é¡¯ç¤ºå‡½æ•¸
        function updateDisplay(data) {
            // æ›´æ–°æº«åº¦é¡¯ç¤º
            temperatureElement.innerHTML = data.temperature.toFixed(1) + '<span class="card-unit">Â°C</span>';
            // æ›´æ–°æ¿•åº¦é¡¯ç¤º
            humidityElement.innerHTML = data.humidity.toFixed(1) + '<span class="card-unit">%</span>';
            // æ›´æ–°ä¿¡è™Ÿå¼·åº¦é¡¯ç¤º
            rssiElement.innerHTML = (data.rssi || '--') + '<span class="card-unit">dBm</span>';
            // æ›´æ–°è¨­å‚™IDé¡¯ç¤º
            deviceIdElement.textContent = data.device || 'æœªçŸ¥è¨­å‚™';
            // æ›´æ–°æ•¸æ“šåŒ…è¨ˆæ•¸é¡¯ç¤º
            packetCountElement.textContent = data.packet_count || '0';

            // ç²å–ç•¶å‰æ™‚é–“
            const now = new Date();
            // æ›´æ–°æœ€å¾Œæ›´æ–°æ™‚é–“é¡¯ç¤º
            lastUpdateElement.textContent = now.toLocaleString('zh-TW');
            // æ›´æ–°æº«åº¦æ›´æ–°æ™‚é–“é¡¯ç¤º
            tempTimeElement.textContent = 'æ›´æ–°: ' + now.toLocaleTimeString('zh-TW');
            // æ›´æ–°æ¿•åº¦æ›´æ–°æ™‚é–“é¡¯ç¤º
            humTimeElement.textContent = 'æ›´æ–°: ' + now.toLocaleTimeString('zh-TW');
        }

        // æ›´æ–°ç‹€æ…‹å‡½æ•¸
        function updateStatus(status, text) {
            // æ›´æ–°ç‹€æ…‹æŒ‡ç¤ºé»é¡å
            statusDot.className = 'status-dot ' + status;
            // æ›´æ–°ç‹€æ…‹æ–‡æœ¬
            statusText.textContent = text;
        }

        // æ·»åŠ æ—¥èªŒè¨˜éŒ„å‡½æ•¸
        function addLog(message) {
            // ç²å–ç•¶å‰æ™‚é–“
            const now = new Date();
            const timestamp = now.toLocaleTimeString('zh-TW'); // æ ¼å¼åŒ–æ™‚é–“
            // å‰µå»ºæ—¥èªŒæ¢ç›®å…ƒç´ 
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry'; // è¨­ç½®é¡å
            logEntry.innerHTML = `<span class="log-time">[${timestamp}]</span> ${message}`; // è¨­ç½®å…§å®¹

            // å°‡æ—¥èªŒæ¢ç›®æ·»åŠ åˆ°æ—¥èªŒå®¹å™¨
            logContainer.appendChild(logEntry);

            // å¦‚æœå•Ÿç”¨äº†è‡ªå‹•æ»¾å‹•ï¼Œå‰‡æ»¾å‹•åˆ°åº•éƒ¨
            if (autoScroll) {
                logContainer.scrollTop = logContainer.scrollHeight;
            }
        }

        // åˆ‡æ›è‡ªå‹•æ»¾å‹•å‡½æ•¸
        function toggleAutoScroll() {
            autoScroll = !autoScroll; // åˆ‡æ›è‡ªå‹•æ»¾å‹•ç‹€æ…‹
            autoScrollStatus.textContent = autoScroll ? 'é–‹' : 'é—œ'; // æ›´æ–°ç‹€æ…‹é¡¯ç¤º
        }

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        window.addEventListener('load', function () {
            // æ·»åŠ åˆå§‹æ—¥èªŒè¨˜éŒ„
            addLog('ğŸŒ ç¶²é ç›£æ§ç•Œé¢å·²å•Ÿå‹•');
            addLog('ğŸ“ˆ åˆå§‹åŒ–å¤šé–“éš”åœ–è¡¨ç³»çµ±...');

            // å»¶é²åˆå§‹åŒ–åœ–è¡¨
            setTimeout(() => {
                initializeCharts(); // åˆå§‹åŒ–åœ–è¡¨
                updateChartVisibility(); // æ›´æ–°åœ–è¡¨å¯è¦‹æ€§
                addLog('âœ… åœ–è¡¨ç³»çµ±åˆå§‹åŒ–å®Œæˆ'); // æ·»åŠ æ—¥èªŒè¨˜éŒ„
                addLog('ğŸ”„ æ”¯æŒé–“éš”: 15ç§’, 30ç§’, 1åˆ†é˜, 30åˆ†é˜'); // æ·»åŠ æ—¥èªŒè¨˜éŒ„
                connectMQTT(); // é€£æ¥MQTT
            }, 100);
        });

        // å®šæ™‚æª¢æŸ¥æ•¸æ“šæ›´æ–°
        setInterval(function () {
            // å¦‚æœæœ‰æœ€å¾Œæ•¸æ“šæ¥æ”¶æ™‚é–“ä¸”è¶…é60ç§’æ²’æœ‰æ–°æ•¸æ“šï¼Œå‰‡æ·»åŠ è­¦å‘Šæ—¥èªŒ
            if (lastDataTime && (new Date() - lastDataTime) > 60000) {
                addLog('âš ï¸ æ•¸æ“šæ›´æ–°å·²åœæ­¢ï¼Œæœ€å¾Œæ›´æ–°: ' + lastDataTime.toLocaleTimeString('zh-TW'));
                lastDataTime = new Date(); // é‡ç½®æœ€å¾Œæ•¸æ“šæ¥æ”¶æ™‚é–“
            }
        }, 30000); // æ¯30ç§’æª¢æŸ¥ä¸€æ¬¡
    </script>
</body>
</html>
